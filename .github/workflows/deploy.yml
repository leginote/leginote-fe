name: Deploy to Oracle Cloud VM (on Pull Request)

on:
  workflow_dispatch:
  push:
    branches:
      - Statpan/issue6

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: leginote1

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create SSH Key and known_hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LEGINOTE1_SSH_KEY }}" > ~/.ssh/leginote1_ssh_key
          chmod 600 ~/.ssh/leginote1_ssh_key
          echo "${{ secrets.KNOWN_HOST }}" > ~/.ssh/known_hosts  # KNOWN_HOSTS Secrets 사용
          chmod 644 ~/.ssh/known_hosts

      - name: Deploy to Oracle Cloud VM (using ssh command)
        run: |
          ssh -i ~/.ssh/leginote1_ssh_key -o UserKnownHostsFile=~/.ssh/known_hosts -p ${{ secrets.LEGINOTE1_PORT }} ${{ secrets.LEGINOTE1_USER }}@${{ secrets.LEGINOTE1_HOST }} \
            "mkdir -p ${{ vars.PROJECT_DIR }} && \
             cd ${{ vars.PROJECT_DIR }} && \
             rsync -avz --delete --exclude 'node_modules' --exclude '.next' --exclude 'public' -e 'ssh -p ${{ secrets.LEGINOTE1_PORT }}' . ${{ secrets.LEGINOTE1_USER }}@${{ secrets.LEGINOTE1_HOST }}:${{ vars.PROJECT_DIR }} && \
             npm ci && \
             npm run build && \
             docker compose up -d --build"

      - name: Clean up SSH key
        if: always()
        run: rm -f ~/.ssh/leginote1_ssh_key ~/.ssh/known_hosts